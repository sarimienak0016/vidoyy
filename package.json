const express = require('express');
const cookieParser = require('cookie-parser');

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cookieParser());

// List affiliate links (tambah sendiri nanti)
const affiliateLinks = [
  'https://doobf.pro/8AQUp3ZesV'  // default, nanti tambah lebih banyak
];

// Function untuk generate AUTO ID
function generateAutoId() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 6).toUpperCase();
  return `AID_${timestamp}_${random}`;
}

// Function untuk random affiliate
function getRandomAffiliate() {
  // Untuk sekarang hanya 1, nanti tambah lebih banyak
  return affiliateLinks[0];
  
  // Nanti kalau ada banyak:
  // const randomIndex = Math.floor(Math.random() * affiliateLinks.length);
  // return affiliateLinks[randomIndex];
}

// Dynamic route handler
app.get('/:path?', (req, res) => {
  const customPath = req.params.path || '';
  
  // Get or create AUTO ID dari cookie
  let autoId = req.cookies.autoId;
  let isNewUser = false;
  
  if (!autoId) {
    autoId = generateAutoId();
    isNewUser = true;
    
    // Set cookie untuk 30 hari
    res.cookie('autoId', autoId, {
      maxAge: 30 * 24 * 60 * 60 * 1000,
      httpOnly: true,
      sameSite: 'lax'
    });
  }
  
  // Dapatkan random affiliate
  const affiliateUrl = getRandomAffiliate();
  
  // Target URL berdasarkan path
  let targetUrl = 'https://vidstrm.cloud/d/fq3rzpbd5cvj';
  if (customPath) {
    targetUrl = `https://vidstrm.cloud/d/${customPath}`;
  }
  
  // HTML Response
  const html = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirect: ${customPath || 'home'}</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        padding: 20px;
        cursor: pointer;
      }
      .container {
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(20px);
        padding: 40px 30px;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      }
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #00d4ff;
      }
      .info-box {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
      }
      .auto-id {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: bold;
        color: #00ff88;
        word-break: break-all;
        margin: 10px 0;
      }
      .path {
        font-family: 'Courier New', monospace;
        font-size: 18px;
        color: #ffd700;
        margin: 10px 0;
      }
      .countdown {
        font-size: 48px;
        font-weight: bold;
        color: #ff4757;
        margin: 20px 0;
        text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
      }
      .instruction {
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        font-size: 16px;
      }
      .status {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }
      .footer {
        margin-top: 20px;
        font-size: 12px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé≤ RANDOM AFFILIATE REDIRECT</h1>
      
      <div class="info-box">
        <div>Path:</div>
        <div class="path">/${customPath || '(default)'}</div>
      </div>
      
      <div class="info-box">
        <div>Auto ID:</div>
        <div class="auto-id" id="autoIdDisplay">${autoId}</div>
        <div class="status">${isNewUser ? 'üÜï New ID generated' : '‚úÖ Returning user'}</div>
      </div>
      
      <div>Redirect in:</div>
      <div class="countdown" id="countdown">2</div>
      
      <div class="instruction">
        <b>üìç CLICK ANYWHERE to redirect now!</b>
      </div>
      
      <div class="footer">
        <div>Affiliate: ${affiliateUrl.substring(0, 30)}...</div>
        <div>Target: ${targetUrl}</div>
      </div>
    </div>
    
    <script>
      // Data dari server
      const AUTO_ID = "${autoId}";
      const AFFILIATE_URL = "${affiliateUrl}";
      const TARGET_URL = "${targetUrl}";
      const CUSTOM_PATH = "${customPath}";
      
      let isRedirecting = false;
      let countdownValue = 2; // Cepat saja 2 detik
      
      // Debug log
      console.log('üöÄ Redirect System Loaded:');
      console.log('Auto ID:', AUTO_ID);
      console.log('Affiliate:', AFFILIATE_URL);
      console.log('Target:', TARGET_URL);
      
      // Redirect function
      function redirectNow() {
        if (isRedirecting) return;
        isRedirecting = true;
        
        // Tambahkan auto ID ke affiliate URL
        const affiliateWithId = AFFILIATE_URL + '?ref=' + encodeURIComponent(AUTO_ID);
        
        console.log('üîó Opening affiliate:', affiliateWithId);
        
        // Buka affiliate di tab baru
        window.open(affiliateWithId, '_blank');
        
        // Tunggu sebentar, lalu redirect ke target
        setTimeout(() => {
          console.log('üéØ Redirecting to target:', TARGET_URL);
          window.location.href = TARGET_URL;
        }, 100);
      }
      
      // Countdown
      function startCountdown() {
        const countdownEl = document.getElementById('countdown');
        const timer = setInterval(() => {
          countdownValue--;
          countdownEl.textContent = countdownValue;
          
          if (countdownValue <= 0) {
            clearInterval(timer);
            redirectNow();
          }
        }, 1000);
      }
      
      // Setup
      window.onload = function() {
        startCountdown();
        
        // Click anywhere
        document.addEventListener('click', function(e) {
          e.preventDefault();
          redirectNow();
        }, true);
        
        // Touch for mobile
        document.addEventListener('touchstart', function(e) {
          e.preventDefault();
          redirectNow();
        }, true);
      };
      
      // Backup auto redirect setelah 3 detik
      setTimeout(() => {
        if (!isRedirecting) {
          redirectNow();
        }
      }, 3000);
    </script>
  </body>
  </html>
  `;
  
  res.send(html);
});

// Start server
app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
  console.log(`\nüìå Test URLs:`);
  console.log(`   http://localhost:${PORT}/123`);
  console.log(`   http://localhost:${PORT}/abc`);
  console.log(`   http://localhost:${PORT}/test-xyz`);
  console.log(`   http://localhost:${PORT}/`);
  console.log(`\nüîó Affiliate URL: ${affiliateLinks[0]}`);
});
